---
title: "Адаптер для взаимодействия со SberBusinessAPI"
date: 2021-10-05T22:57:32+03:00
type: sber
menu:
  main:
    name: "Адаптер для взаимодействия с SberBusinessAPI"
    weight: 505
    parent: "Компоненты"
---

# Адаптер для взаимодействия с SberBusinessAPI
---

## Технические требования для адаптера

1. Виртуальный сервер: 2 vCPU, 4 GB RAM, 100 GB HDD.
2. Операционная система Microsoft Windows Server 2016 или более поздняя версия.
3. База данных PostgreSQL 12 или более поздняя версия.
4. Наличие доступа в Интернет для сервера с адаптером к сервису взаимодействия
Сбербанка.
5. Наличие доступа в Интернет для рабочего места пользователя, для подписания
оферты на сайте Сбербанка.
6. Наличие внешнего адреса в Интернет для сервера с адаптером, для
автоматизированного получения ключей авторизации от Сбербанка.
7. Ключ для создания TLS соединения, подписанный УЦ Сбербанка. [Инструкция по
выпуску ключа](https://developer.sberbank.ru/doc/v3/sbbol/common)

### Технологическая схема взаимодействия

Технологическая схема взаимодействия Транзит 2.0 с адаптером SberBusiness API приведена на рисунке 1.

| ![](/images/sber/1.png "Рисунок 1")                  |
|:----------------------------------------------------:|
| *Рисунок 1. Технологическая схема взаимодействия*    |

Организации у своего менеджера в банке необходимо получить:
- URL SberBusinessAPI (Fintech API).
- Учетные данные для адапетра (Client_id и Client_secret).
- Scope, необходимый для авторизации пользователя

Полная документация по подключению доступа на сайте Сбербанка [тут](https://developer.sberbank.ru/doc/v3/sbbol/reg).

Авторизация Холдингов в SberBusiness API:
- Для получения токена авторизации от банка для компаний, входящих в Холдинг, Адаптер SberBusiness API lдолжен быть доступен из Интернет для банка по ссылке, которая указывается в личном кабинете пользователя Организации Сбербанка.

## Настройка Адаптера SberBusinessAPI:

### Установка Адаптера:

Для работы адаптера требуется внешнее HTTP или HTTPS соединение, в зависимости от выбранного протокола, пропустите один из шагов.

1. Для инициализации HTTP порта входящего трафика необходимо запустить
Адаптер с правами администратора или добавить адрес в разрешенные командой в
консоли командной строки: netsh http add urlacl url=http://+:8080/
user=Все (Все/Everyone) - зависит от языка системы.
2. Для инициализации HTTPS порта входящего трафика необходимо:
    - Создать ключ в формате *.pfx для установки на сервер.
    - Добавить ключ и порт в разрешенные для адаптера командой в консоли
командной строки: netsh http add sslcert ipport=0.0.0.0:8443
certhash=<Certificate Thumbprint> appid= {837ba04c-af5c-3c13-aed3-
3e4881d44c41}
3. Распаковать архив с Адаптером в любой удобный каталог
4. В каталоге ../config создать файл config.json. ([Подробнее](/sber/index.html#описание-конфигурационного-файла-configjson-для-адаптера))
5. В конфигурационном файле Адаптера добавить признак IsLocal и справочник
ИНН - депозитарный код для каждой организации.
6. Запустить initService.ps1 из каталога дистрибутива.

### Обновление Адаптера:

1. Остановить сервис
2. Заменить каталог bin на каталог bin из архива с обновлением.
3. Запустить сервис

*Наименование сервиса «Адаптер к SberBusiness API»

## Настройка Терминала Транзита:

По умолчанию Терминал Транзита взаимодействует со Сбербанком через канал ЭДО
НРД. Для переключения режима работы с локальным адаптером необходимо выполнить
следующие операции:

1. В конфигурационном модуле Сбербанка (расположен в каталоге установки
Терминала Транзита ../bin/config/sberbank добавить блок Middleware.

Блок содержит следующие атрибуты:

- Address – адрес адаптера в ИТ инфраструктуре компании,
- Scope - указываются разрешения, полученные у менеджера банка.
- RedirectUri - ссылка для переадресации. Указывается внешний адрес адаптера в ИТ инфраструктуре компании.
- ClientId - Идентификатор клиента, полученный у менеджера банка.
- PersonCode – NDC0000000TR
- InboxPath - Каталог с входящими документами, должен совпадать с OUTBOX_DIRECTORY в конфигурационном файле Адаптера
- OutboxPath - Каталог с исходящими документами, должен совпадать с INBOX_DIRECTORY в конфигурационном файле Адаптера
- ProcessedPath - Каталог с обработанными документами
- ErrorPath - Каталог с ошибками

### Подписание оферты Сбербанка:

1. Для начала работы необходимо на рабочем месте пользователя авторизоваться ключом Сбербанка в Сбербанк Бизнес Онлайн.
2. В интерфейсе Терминала Транзита открыть «Настройки – Банковские модули – Сбербанк»
3. Нажать кнопку «Подписать оферту» после чего будет выполнен переход на сайт Сбербанка для ознакомления с офертой и подписания.
4. После подписания в интерфейсе Терминала Транзита перейти в «Настройки – Банковские модули – Сбербанк» и проверить, что в Таблице кодов авторизации добавлен код авторизации для организации.
5. В интерфейсе Терминала Транзита перейти в «Настройки – Организации» выбрать организацию, для которой выполнялось подписание оферты в п.3 и в карточке данной организации выбрать в меню «Идентификатор Сбербанка (КПП)» соответствующий код авторизации из п.4

## Описание конфигурационного файла config.json для Адаптера:
```
"CONNECTION_STRING": "Server=localhost;Port=5432;Database=sberbankapi;UserId=postgres;Password=1234" – параметры подключения к БД. Параметр Database должен отличаться от БД Транзит 2.0

"FINTECH_URL": "https://edupirfintech.sberbank.ru:9443", - адрес веб сервиса Сбербанка

"SERVICE_URL": "https://www.nsd.ru:8443", - адрес redirect_uri (внешний адрес адаптера)

"INBOX_DIRECTORY": "C://SBER//IN", - каталог для входящих сообщений

"OUTBOX_DIRECTORY": "C://SBER//OUT", - каталог для исходящих сообщений

"PROCESSED_DIRECTORY": "C://SBER//PRC", - каталог для обработанных сообщений

"TEMP_DIRECTORY": "C://SBER//TEMP", - каталог для временных файлов

"ERROR_DIRECTORY": "C://SBER//ERROR", - каталог для ошибочно обработанных сообщений

"PFX_CERTIFICATE_FILE": "C://SBER//cert.pfx", - сертификат в формате *.pfx для установки зашифрованного соединение к fintech_url

"PFX_CERTIFICATE_PASSWORD": "PaSsWoRd", - пароль от ключа контейнера

"CLIENT_ID": "1234", - client_id, выданный банком

"CLIENT_SECRET": "sEcReT", - client_secret, выданный банком

"LOG_DIR": "C://SBER//log", - каталог сохранения журнала событийs

"WAIT_RESCAN_DURATION_MS": 2000, - интервал опроса каталогов в мс. (не менять)

"MAX_DEGREE_OF_PARALLELISM": 5, - многопоточность (не менять)

"HTTP_LISTENER_PORT": 8080, - порт прикрепления сервиса, указанный в п 8 или 9 при установке адаптера

"RESEND_STATE_REQUEST_TIME": 1,
"DEPONENT_CODES": {
  "7746320061": "NDC0000000TR",
  "7746320062": "NDC0000000TR"– Справочник ИНН – депозитарный код.
},
"IS_LOCAL": true – локальный режим работы адаптера
```
